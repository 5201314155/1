# 构建与测试记录

## 2025-12-09 APK 打包尝试
- 命令：`gradle assembleDebug --console=plain --no-daemon`
- 结果：失败，原因是容器无法从远程仓库解析 `com.android.application` 插件 8.5.0（缺少网络/缓存）。
- 处理建议：在具备 Android SDK 与可访问 Google Maven 的环境下重试，或提前准备离线插件缓存。

## 2025-12-10 Termux 自动打包脚本
- 新增 `termux_build.sh`（原 `Termux打包脚本.sh`），在 Termux 环境下自动检测 `JAVA_HOME` 与 `ANDROID_HOME`，并根据可用性选择 `gradlew` 或全局 `gradle`。
- 默认执行 `assembleDebug`，可通过参数指定其他任务（如 `bundleRelease`）。
- 在 Termux 设备上执行示例：`bash termux_build.sh --info`（可加入额外 Gradle 选项），产物位于 `app/build/outputs/`。

## 2025-12-11 运行打包脚本封装
- 新增打包快捷脚本（后续更名为 `run_build.sh`），作为入口调用 `termux_build.sh`，自动赋权并传递构建任务。
- 默认任务为 `assembleDebug`，可通过参数指定 `assembleRelease`/`bundleRelease` 等，输出目录保持 `app/build/outputs/`。
- 便于在 Termux 终端中直接执行脚本完成构建，避免重复记忆长命令。

## 2025-12-12 run 打包入口兼容性
- 依据“run”命名习惯，将快捷脚本更名为 `run_build.sh`，避免部分存储挂载下的 `./` 可执行限制。
- 更新调用方式为 `bash run_build.sh [任务]`，脚本内部也以 `bash` 触发 `termux_build.sh`，提升在手机端的兼容性。

## 2025-12-13 脚本命名英文化
- 应用户要求移除中文脚本命名，统一保留 `termux_build.sh`、`run_build.sh`，并提供兼容入口 `legacy_run_build.sh`。
- 文档说明与示例命令同步替换，确保 Termux 端继续可用。

## 2025-12-15 run.sh 自动安装器触发
- 将一键入口统一为 `run.sh`，继续以 bash 调用 `termux_build.sh` 完成构建。
- 构建成功后自动在 `app/build/outputs/` 内寻找最新 APK，优先使用 `termux-open`，若不可用则回退 `am` 触发系统安装器。
- `legacy_run_build.sh` 仍可调用，但内部已转发到 `run.sh` 以复用自动安装逻辑。

## 2025-12-17 画布图层交互更新后的验证
- 变更类型：UI 交互与状态同步（画布图层、可见性、锁定状态）。
- 容器限制：当前环境缺少 Android SDK 与相关依赖，未实际运行 Compose 预览或 APK 构建。
- 后续建议：在具备 SDK 的 Termux/本地环境执行 `bash run.sh assembleDebug`，并打开应用验证图层列表、可见性和锁定切换的表现。

## 2025-12-18 Termux 打包权限兼容性
- 发现共享存储挂载下无法 `chmod +x gradlew` 的场景，导致 `bash run.sh` 提示无法修复权限。
- 已在 `termux_build.sh` 增加 `bash gradlew` 兜底调用，遇到权限限制也能继续构建；建议在有可执行挂载时再为 wrapper 赋权。
- 未在容器执行（缺少 Termux/Android SDK）；请在手机端重试 `bash run.sh` 确认问题已解决。

## 2025-12-19 资源链接失败原因与修复
- 复现日志：`processDebugResources` 阶段提示 `Theme.Material3.DayNight.NoActionBar` 未找到，导致 AAPT 链接失败。
- 原因：未引入提供 Material3 视图主题资源的 `com.google.android.material:material` 依赖，仅有 Compose Material3 无法满足 XML 样式解析。
- 处理：在 `app/build.gradle.kts` 添加 `material:1.12.0` 依赖，后续在具备 SDK 的环境运行 `bash run.sh assembleDebug` 验证资源链接通过。

## 2025-12-20 Kotlin 编译错误排查
- 复现日志：`compileDebugKotlin` 阶段提示 `Save`、`Smartphone`、`BottomToolBar`、`PaddingValues` 未解析，以及 TopAppBar 实验性 API 报错。
- 原因：缺少 Material 扩展图标依赖、未定义底部工具栏组件、未导入 `PaddingValues`，且 TopAppBar 使用需显式 `@OptIn`。
- 处理：在 `app/build.gradle.kts` 增加 `material-icons-extended`；补充 `BottomToolBar` 组件与相关导入，在 `StudioHomeScreen` 添加 `@OptIn(ExperimentalMaterial3Api::class)`；待 Termux/本地环境具备 SDK 后重跑 `bash run.sh assembleDebug` 验证编译通过。

## 2025-12-21 run.sh 菜单化与兼容性精简
- 变更：删除 `termux_build.sh` 与 `legacy_run_build.sh`，统一改用单一入口 `run.sh`。
- 主要选项：
  - `bash run.sh 1` 下载/刷新依赖。
  - `bash run.sh 2` 检查 Termux/JDK/SDK/Gradle 环境。
  - `bash run.sh 3` 完整构建 `clean assembleDebug` 并自动触发安装器（默认行为）。
  - `bash run.sh 4` 仅启动安装器，安装最新 APK。
  - `bash run.sh 5` 增量构建 `assembleDebug` 并自动触发安装器。
- 状态：受限于容器环境（无 Android SDK/Termux），未实际运行；请在手机或本地 SDK 环境执行上述选项验证。

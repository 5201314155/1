# 构建与测试记录

## 2025-12-09 APK 打包尝试
- 命令：`gradle assembleDebug --console=plain --no-daemon`
- 结果：失败，原因是容器无法从远程仓库解析 `com.android.application` 插件 8.5.0（缺少网络/缓存）。
- 处理建议：在具备 Android SDK 与可访问 Google Maven 的环境下重试，或提前准备离线插件缓存。

## 2025-12-10 Termux 自动打包脚本
- 新增 `termux_build.sh`（原 `Termux打包脚本.sh`），在 Termux 环境下自动检测 `JAVA_HOME` 与 `ANDROID_HOME`，并根据可用性选择 `gradlew` 或全局 `gradle`。
- 默认执行 `assembleDebug`，可通过参数指定其他任务（如 `bundleRelease`）。
- 在 Termux 设备上执行示例：`bash termux_build.sh --info`（可加入额外 Gradle 选项），产物位于 `app/build/outputs/`。

## 2025-12-11 运行打包脚本封装
- 新增打包快捷脚本（后续更名为 `run_build.sh`），作为入口调用 `termux_build.sh`，自动赋权并传递构建任务。
- 默认任务为 `assembleDebug`，可通过参数指定 `assembleRelease`/`bundleRelease` 等，输出目录保持 `app/build/outputs/`。
- 便于在 Termux 终端中直接执行脚本完成构建，避免重复记忆长命令。

## 2025-12-12 run 打包入口兼容性
- 依据“run”命名习惯，将快捷脚本更名为 `run_build.sh`，避免部分存储挂载下的 `./` 可执行限制。
- 更新调用方式为 `bash run_build.sh [任务]`，脚本内部也以 `bash` 触发 `termux_build.sh`，提升在手机端的兼容性。

## 2025-12-13 脚本命名英文化
- 应用户要求移除中文脚本命名，统一保留 `termux_build.sh`、`run_build.sh`，并提供兼容入口 `legacy_run_build.sh`。
- 文档说明与示例命令同步替换，确保 Termux 端继续可用。

## 2025-12-15 run.sh 自动安装器触发
- 将一键入口统一为 `run.sh`，继续以 bash 调用 `termux_build.sh` 完成构建。
- 构建成功后自动在 `app/build/outputs/` 内寻找最新 APK，优先使用 `termux-open`，若不可用则回退 `am` 触发系统安装器。
- `legacy_run_build.sh` 仍可调用，但内部已转发到 `run.sh` 以复用自动安装逻辑。

## 2025-12-17 画布图层交互更新后的验证
- 变更类型：UI 交互与状态同步（画布图层、可见性、锁定状态）。
- 容器限制：当前环境缺少 Android SDK 与相关依赖，未实际运行 Compose 预览或 APK 构建。
- 后续建议：在具备 SDK 的 Termux/本地环境执行 `bash run.sh assembleDebug`，并打开应用验证图层列表、可见性和锁定切换的表现。

## 2025-12-18 Termux 打包权限兼容性
- 发现共享存储挂载下无法 `chmod +x gradlew` 的场景，导致 `bash run.sh` 提示无法修复权限。
- 已在 `termux_build.sh` 增加 `bash gradlew` 兜底调用，遇到权限限制也能继续构建；建议在有可执行挂载时再为 wrapper 赋权。
- 未在容器执行（缺少 Termux/Android SDK）；请在手机端重试 `bash run.sh` 确认问题已解决。

## 2025-12-19 资源链接失败原因与修复
- 复现日志：`processDebugResources` 阶段提示 `Theme.Material3.DayNight.NoActionBar` 未找到，导致 AAPT 链接失败。
- 原因：未引入提供 Material3 视图主题资源的 `com.google.android.material:material` 依赖，仅有 Compose Material3 无法满足 XML 样式解析。
- 处理：在 `app/build.gradle.kts` 添加 `material:1.12.0` 依赖，后续在具备 SDK 的环境运行 `bash run.sh assembleDebug` 验证资源链接通过。

## 2025-12-20 Kotlin 编译错误排查
- 复现日志：`compileDebugKotlin` 阶段提示 `Save`、`Smartphone`、`BottomToolBar`、`PaddingValues` 未解析，以及 TopAppBar 实验性 API 报错。
- 原因：缺少 Material 扩展图标依赖、未定义底部工具栏组件、未导入 `PaddingValues`，且 TopAppBar 使用需显式 `@OptIn`。
- 处理：在 `app/build.gradle.kts` 增加 `material-icons-extended`；补充 `BottomToolBar` 组件与相关导入，在 `StudioHomeScreen` 添加 `@OptIn(ExperimentalMaterial3Api::class)`；待 Termux/本地环境具备 SDK 后重跑 `bash run.sh assembleDebug` 验证编译通过。

## 2025-12-21 run.sh 菜单化与兼容性精简
- 变更：删除 `termux_build.sh` 与 `legacy_run_build.sh`，统一改用单一入口 `run.sh`。
- 主要选项：
  - `bash run.sh 1` 下载/刷新依赖。
  - `bash run.sh 2` 检查 Termux/JDK/SDK/Gradle 环境。
  - `bash run.sh 3` 完整构建 `clean assembleDebug` 并自动触发安装器（默认行为）。
  - `bash run.sh 4` 仅启动安装器，安装最新 APK。
  - `bash run.sh 5` 增量构建 `assembleDebug` 并自动触发安装器。
- 状态：受限于容器环境（无 Android SDK/Termux），未实际运行；请在手机或本地 SDK 环境执行上述选项验证。

## 2025-12-22 假手机预览布局调整后的状态
- 变更：画布预览加入假手机上中下分区、预览模式切换与多机型尺寸芯片选择，强调组件属性仅基于假手机计算。
- 状态：本地容器缺少 Android SDK/Termux，未执行构建或预览；建议在手机端运行 `bash run.sh 3` 重新生成 APK，验证预览切换和假手机视图。

## 2025-12-23 区域化属性与假手机画布深化
- 变更：在属性面板新增区域选择器与宽高/透明度滑杆，画布分区支持顶部/中部/底部切换并展示组件占位，保持预览与编辑一致。
- 状态：容器仍无 Android SDK/Termux 环境，未运行 `bash run.sh`；请在手机端或本地 SDK 环境执行完整构建以验证新属性编辑与区块预览。

## 2025-12-24 手机端尺寸约束验证提示
- 变更：设备预设增加宽高参数，属性滑杆随手机宽度与分区高度自动限值，画布分区提示展示可用宽高，确保布局 100% 面向手机端。
- 状态：仍未在缺少 Android SDK 的容器执行构建；请在 Termux/本地 SDK 环境重跑 `bash run.sh 3` 或 `bash run.sh 5` 验证新尺寸约束是否正常生效，并检查自动安装流程。

## 2025-12-25 run.sh 默认 clean 失败的修复
- 复现日志：Termux 执行 `bash run.sh`（默认选项 3，调用 `clean assembleDebug`）时报 `Task 'clean' not found in root project 'XiaoYunUI-Studio'`。
- 原因：根项目未注册 `clean` 任务，导致默认完整构建流程缺少清理步骤。
- 处理：在根 `build.gradle.kts` 注册 `clean` 删除构建目录，保持与 `run.sh` 完整构建流程对齐；请在移动端重新执行 `bash run.sh 3` 验证构建可继续。

## 2025-12-26 aapt2 架构报错与脚本兼容
- 复现日志：Termux 端 `bash run.sh` 构建时，Gradle 下载的 `aapt2-8.5.0-11315950-linux/aapt2` 在手机架构上报 `Syntax error: "(" unexpected`，随后 `processDebugResources` 因无法编译资源而失败。
- 原因：AGP 默认拉取 PC 架构 aapt2，手机端执行时二进制架构不匹配。
- 处理：`run.sh` 新增本地 aapt2 优先策略，依次查找 Termux `aapt2` 或 SDK `build-tools/*/aapt2`，并通过 `-Dandroid.aapt2FromMaven=false -Dandroid.aapt2FromMavenOverride=<path>` 强制使用匹配架构；若未找到匹配版本，脚本会提示先安装后再构建。

## 2025-12-27 aapt2 自动定位完善
- 变更：`run.sh` 在 Termux 前缀 (`$PREFIX`) 下优先搜索包管理器安装的 `build-tools/*/aapt2`（如 `pkg install android-tools`/`aapt`），再回落至 PATH 和 ANDROID_HOME，确保自动使用手机可执行的 aapt2，避免再次拉取 PC 版本。
- 状态：容器内缺少 Termux/Android SDK，未能实机验证；建议在手机端重新执行 `bash run.sh 3` 或 `bash run.sh 5`，确认 aapt2 覆盖日志显示已命中本地二进制。

## 2025-12-28 aapt2 PC 缓存残留导致的失败
- 复现日志：Termux 端 `bash run.sh` 输出 `aapt2 ... Syntax error: "(" unexpected`，随后 `processDebugResources` 失败。
- 原因：Gradle 缓存内残留 PC 架构 aapt2，被手机端构建调用；本地未安装匹配架构 aapt2 时会继续触发缓存错误。
- 处理：`run.sh` 在构建前自动扫描 `~/.gradle/caches` 删除与当前架构不符的 aapt2 二进制，并在未找到本地 aapt2 时直接终止，提示先通过 `pkg install aapt` 或同步 aarch64 build-tools 后再运行 `bash run.sh 3/5`。

## 2025-12-29 Gradle 缓存被修改报错的修复
- 复现日志：Termux 构建阶段报 `immutable workspace ... have been modified`，指向 `.gradle/caches/9.2.0/transforms/.../aapt2-8.5.0-11315950-linux` 目录。
- 原因：为清理 PC 架构 aapt2 时仅删除了缓存中的单个二进制文件，导致 Gradle 认为 transform 工作区被外部修改。
- 处理：`run.sh` 默认将 Gradle 用户目录隔离到仓库下的 `.gradle-mobile` 并在发现架构不匹配的 aapt2 时整目录删除对应 transform，避免部分文件被修改；建议在手机端重新运行 `bash run.sh 3` 以使用隔离缓存重新生成资源编译依赖。

## 2025-12-30 aapt2 自动安装与缓存清理后的重试指引
- 复现日志：Termux 构建仍报 `processDebugResources`，指向 `.gradle-mobile` 内 `aapt2-8.5.0-11315950-linux` 变换目录（PC 架构导致守护进程启动失败）。
- 处理：`run.sh` 启动时直接清理 Gradle 缓存中所有 aapt2 相关 transform 目录，并强制使用隔离的 `.gradle-mobile`；未找到本地 aapt2 时，在 Termux 自动尝试 `pkg install -y aapt android-tools` 获取手机架构 aapt2，仍缺失则终止提示安装后再重试。
- 使用方式：在 Termux 执行 `bash run.sh 3`（完整构建）或 `bash run.sh 5`（增量构建），确保日志出现“已启用本地 aapt2 覆盖”且路径指向手机端 aapt2；构建成功后脚本会自动查找最新 APK 并调起安装器。

## 2025-12-31 Termux 架构锁定与缓存清理强化
- 目标：解决 Termux 构建仍触发 PC 架构 aapt2 或缓存不可变报错的问题，确保小白运行 `bash run.sh` 即可完成构建与安装。
- 措施：
  - 脚本启动即锁定 `REPO_OS_OVERRIDE=linux`、`REPO_ARCH_OVERRIDE=arm64`，并统一 `ANDROID_HOME=/data/data/com.termux/files/home/android-sdk`、`GRADLE_OPTS=-Dorg.gradle.jvmargs=-Xmx1536m -Dfile.encoding=UTF-8`，清理 `JAVA_TOOL_OPTIONS/_JAVA_OPTIONS`。
  - 强制使用项目 Wrapper（`bash gradlew`），禁用系统 Gradle 回退；构建前自动删除隔离 `.gradle-mobile` 中的 `caches/daemon/native` 以及 `~/.android`、`~/.cache/gradle`，防止序列化/immutable workspace 冲突。
  - aapt2 只接受 ARM64：优先 `/data/data/com.termux/files/home/android-tools-arm64/aapt2`，再查 Termux/SDK，`file` 架构不含 ARM/aarch64 则直接失败提示安装；继续强制 `-Dandroid.aapt2FromMaven=false -Dandroid.aapt2FromMavenOverride=<本机aapt2>`。
- 待验证：在手机端执行 `bash run.sh 2` 查看环境与 aapt2 架构日志，随后运行 `bash run.sh 3` 或 `bash run.sh 5`，确认未再出现 aapt2 架构或缓存报错且可自动调起安装器。

## 2026-01-01 Kotlin 编译失败定位与修复
- 报错：`:app:compileDebugKotlin` 出现 `Chip/ChipDefaults unresolved`、`Modifier.weight` 未解析、`Composable` 上下文错误，根因是 Compose BOM 2024.06.00 对应的 Material3 1.2.x 已移除旧版 `Chip` API，且导入缺失。
- 处理：主界面改用 `SuggestionChip`/`SuggestionChipDefaults`，补齐 `Modifier.weight` import，对齐最新 API 签名，确保属性编辑与设备尺寸选择的 Chip 仍可用。
- 待验证：手机端重新执行 `bash run.sh 3`（或增量编译选项）确认 Kotlin 编译通过，保持 ARM64 aapt2 覆盖与隔离缓存策略不变。

## 2026-01-02 Kotlin 编译再次报 weight 作用域错误
- 报错：`:app:compileDebugKotlin` 指向 `PhoneCanvasArea` 内部的 `.weight(1f)`，提示 `RowColumnParentData.weight` 作用域不匹配/不可访问。
- 处理：新增 `modifier` 参数，由父级 `PhoneFramePreview` 的 `ColumnScope` 传入 `Modifier.weight(1f)`，并移除子组件内部的裸 `weight` 调用，避免作用域错误，保持画布区域仍然占满剩余高度。
- 待验证：在 Termux/手机端运行 `bash run.sh 3` 或 `bash run.sh 5`，确认 Kotlin 编译阶段不再出现 `weight` 相关报错，资源编译阶段继续沿用本机 aapt2 覆盖与隔离缓存策略。

## 2026-01-03 Compose 对齐/内边距升级未实机验证
- 变更：属性面板新增组件水平对齐与内边距调节，画布预览按新属性动态收缩宽度并对齐展示，宽度滑杆上限随内边距同步调整。
- 状态：容器内缺少 Android/Termux 环境，未执行 `bash run.sh`；建议在手机端使用菜单 3 或 5 重新编译确认 Kotlin 阶段无新增报错，资源阶段继续使用本机 ARM64 aapt2。

## 2026-01-04 图层管理操作扩展
- 变更：属性面板的图层列表加入上移/下移、复制、删除按钮，复制后自动聚焦新图层，删除后自动回退到最近图层，保持编辑流程可继续。
- 状态：仍在无 Android SDK/Termux 的容器中，未运行构建；请在手机端执行 `bash run.sh 3` 或 `bash run.sh 5`，确认 Kotlin 编译不再出现层级操作相关报错，资源编译继续使用本机 ARM64 aapt2 覆盖。

## 2026-01-05 假手机校验与尺寸计算调整
- 变更：新增统一的分区高度/可用宽度计算方法并在属性面板加入“假手机校验”卡片，标记宽高越界或透明度过低的情况，尺寸滑杆上限改为直接使用统一计算结果。
- 状态：当前容器无 Android SDK/Termux 环境，未实际运行 `bash run.sh`；请在手机端或本地 SDK 环境执行菜单 3/5，确认 Kotlin 编译阶段通过、属性校验提示随设备和区域更新，资源编译依旧使用本机 ARM64 aapt2。

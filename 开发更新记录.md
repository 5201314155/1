# 开发更新记录

## 2025-12-09 布局调整
- 以剪映应用的三栏布局为参考，完成主界面骨架：左侧组件库、中部手机画布、右侧属性面板，下方工具栏突出图层和对齐能力。
- 画布采用手机框架展示，不依赖真机属性，预览视图即等同进入应用效果，确保后续生成代码可兼容所有尺寸。
- 顶部加入保存与预览操作入口，为后续APK打包与快速校验留出入口位。

## 2025-12-09 构建与测试尝试
- 执行 `gradle assembleDebug` 进行APK打包验证，因容器无法从远程仓库获取 Android Gradle Plugin 8.5.0 而失败，需在可访问Google Maven或有本地缓存的环境复测。
- 失败日志已记录，便于后续在具备SDK与网络的机器上对照排查并完成正式打包。

## 2025-12-10 Termux 打包支持
- 编写 `termux_build.sh`（原 `Termux打包脚本.sh`），自动识别 Termux 环境并复用本机 JDK/SDK 配置，便于在手机端直接打包。
- 补充《Termux 打包说明》，明确依赖安装、脚本用法及常见问题，方便快速在移动端复现构建。

## 2025-12-11 运行打包脚本
- 新增打包快捷脚本（后续更名为 `run_build.sh`），将 Termux 打包流程封装为一键入口，默认执行 `assembleDebug`，可按需传入其他任务。
- 文档同步更新，强调直接在 Termux 终端执行即可完成打包，减少记忆成本。

## 2025-12-12 run 打包入口调整
- 按照“run”命名要求，将一键脚本更名为 `run_build.sh`，避免与终端 `./` 兼容性问题。
- 默认用 `bash run_build.sh` 调用，并在脚本内改为 `bash` 触发 `termux_build.sh`，适配手机端文件系统限制。

## 2025-12-13 脚本命名英文化
- 应用户要求，移除中文脚本命名，统一为 `termux_build.sh` 与 `run_build.sh`，并保留 `legacy_run_build.sh` 兼容旧调用。
- 文档同步替换调用示例，便于在手机端直接使用 `bash` 方式执行。

## 2025-12-14 已完成功能汇总
- 新增《已完成功能列表》，集中描述当前已交付的 CP0 架构、剪映式主界面骨架、手机画布预览与 Termux 打包脚本可用性。
- README 增补“当前进展速览”提示，便于快速了解现阶段成果与后续优先事项。

## 2025-12-15 run 打包脚本与安装器联动
- 将打包入口统一命名为 `run.sh`，保持英文脚本名并用 bash 直接调用，减少移动端文件系统的可执行限制问题。
- 在打包成功后自动定位最新 APK 并通过 `termux-open` 或 `am` 触发系统安装器，实现“一键打包后一键安装”的体验。
- `legacy_run_build.sh` 改为转发到 `run.sh`，兼容旧命令同时复用自动安装流程。

## 2025-12-16 画布与属性联动增强
- 为组件库加入选中高亮与点击交互，当前选中组件会同步到画布预览与属性面板，便于后续生成代码前的配置。
- 新增缩放滑杆，支持 50%~250% 画布缩放，并在状态条与属性面板中实时显示百分比，强调“预览等同真机”的呈现。
- 画布内容增加智能提示卡片，突出对齐参考线入口与选中组件的适配展示，持续贴合剪映式布局体验。

## 2025-12-17 画布图层与可见性控制
- 组件库新增“一键添加到画布”按钮，可将当前选中组件快速生成图层，保持中央画布与右侧属性面板同步。
- 画布预览与属性面板均显示图层列表，支持聚焦选中组件、显示/隐藏切换与锁定/解锁，强化剪映式图层管理体验。
- 状态条、缩放提示与图层状态保持实时同步，为后续真机等效预览与代码生成打下基础。

## 2025-12-18 移动端打包兼容与画布易用性
- `termux_build.sh` 在共享存储无法修改执行权限时自动切换 `bash gradlew`，确保 `bash run.sh` 仍可在手机端直接打包。
- 画布缩放新增“还原”按钮，一键重置到 100%，便于快速回到真机等效的预览比例。

## 2025-12-19 资源构建问题修复
- 修复 `Theme.Material3.DayNight.NoActionBar` 样式缺失导致的资源链接失败，新增 `com.google.android.material:material` 依赖以提供 Material3 主题资源。
- 提醒后续在 Termux/本地环境重新执行 `bash run.sh assembleDebug`，验证资源链接已通过并可继续生成 APK。

## 2025-12-20 Kotlin 编译错误修复与底部工具栏细化
- 处理打包日志中的未解析图标/实验性 API 报错：引入 `material-icons-extended` 以提供 `Save`、`Smartphone` 等图标，添加 `@OptIn(ExperimentalMaterial3Api::class)` 解决 TopAppBar 实验特性编译要求，并补全缺失的 `PaddingValues` 导入。
- 为主页新增 `BottomToolBar` 组件，保留保存/导出/预览的按钮提示，维持剪映式底部操作区的交互一致性。

## 2025-12-21 run.sh 统一化与菜单化
- 移除旧的 `termux_build.sh` 与 `legacy_run_build.sh`，只保留 `run.sh` 作为唯一入口。
- `run.sh` 增加 5 个菜单选项：下载依赖、检查环境、完整构建（含自动安装）、仅启动安装器、增量构建（含自动安装），默认执行完整构建。
- 文档同步更新调用方式，确保在 Termux/手机端仅需 `bash run.sh [选项]` 即可完成日常操作。

## 2025-12-22 假手机画布分区与预览模式
- 画布预览新增“假手机”状态栏、主体画布与底部操作栏三段式布局，直接对齐上中下的手机视图示意，突出“画布=手机”。
- 引入多机型尺寸选项与芯片式切换，组件属性仅基于假手机尺寸计算，强调与真机参数脱钩的兼容原则。
- 实时预览按钮可切换编辑/预览模式，状态栏、底部栏与画布文案同步反映“预览即进入应用”的体验。

## 2025-12-23 区域化组件属性与假手机画布深化
- 画布区域支持“顶部/中部/底部”三段切换，属性面板新增区域选择器，确保组件在假手机不同区块的布局可视化一致。
- 属性面板补充宽度/高度/透明度滑杆，锁定状态下禁用修改，保持画布预览与属性侧栏的真机等效同步。
- 假手机画布新增区块背景与组件占位可视化，显示当前缩放比例、所选设备与选中组件信息，增强“画布=手机”体验。

## 2025-12-24 手机端尺寸约束与属性联动
- 假手机设备预设加入宽高参数，区域分区同步展示可用宽高并提醒“宽度<=设备dp，高度<=分区dp”，突出全部布局以手机端为基准。
- 属性面板选中卡片显示当前假手机名称与尺寸，宽高滑杆随设备和分区自动限值，避免生成超出手机范围的布局，并保持缩放/预览信息同步。

## 2025-12-25 构建入口清理与兼容
- 针对 Termux 日志中 `Task 'clean' not found` 的报错，在根级 `build.gradle.kts` 注册 `clean` 任务，确保 `bash run.sh 3` 默认的 `clean assembleDebug` 能正常执行。
- 持续沿用 `run.sh` 单一入口，移动端执行时无需调整命令即可完成完整构建与自动安装。

## 2025-12-26 aapt2 架构兼容
- `run.sh` 在环境检查和构建前优先寻找本机 aapt2（Termux `pkg install aapt` 或 SDK build-tools），通过 `-Dandroid.aapt2FromMavenOverride` 强制使用匹配架构，避免下载 PC 版 aapt2 导致手机端报错。
- 《Termux 打包说明》同步提示 aapt2 本地化方案，指导先安装可执行的 aapt2 后再执行 `bash run.sh`，以提升手机端构建稳定性。

## 2025-12-27 aapt2 Termux 自动定位优化
- `run.sh` 进一步在 Termux 前缀路径 (`$PREFIX`) 下搜索包管理器安装的 `build-tools/*/aapt2`，并在 PATH/ANDROID_HOME 之间按优先级选择，自动落地到手机可执行的 aapt2。
- 文档同步说明新的查找顺序，提示可通过 `pkg install android-tools`/`aapt` 获得本机 aapt2，再由脚本自动接管，减少手动配置。

## 2025-12-28 aapt2 架构缓存清理与强制本地校验
- `run.sh` 构建前会扫描并清理 Gradle 缓存内与当前架构不匹配的 aapt2 二进制，避免再次触发 PC 版 aapt2 的 `Syntax error: "(" unexpected` 报错。
- 若未找到本机可用的 aapt2（Termux 包或 SDK build-tools），脚本会停止并提示安装 `pkg install aapt`/同步 aarch64 build-tools，再重试构建。

## 2025-12-29 Gradle 缓存隔离与 aapt2 transform 清理
- `run.sh` 默认将 Gradle 用户目录隔离到仓库内的 `.gradle-mobile`，避免复用桌面端生成的 PC 架构缓存导致手机端报错；如需复用现有缓存，可显式设置 `GRADLE_USER_HOME`。
- 对检测到架构不匹配的 aapt2，会整体删除对应 transform 目录，而非修改单个文件，防止 Gradle 报“immutable workspace 被修改”并允许重新生成匹配架构的缓存。

## 2025-12-30 aapt2 自动安装与本地化强制
- `run.sh` 构建前直接删除缓存中所有 aapt2 相关 transform 目录，并依旧使用隔离的 `.gradle-mobile`，彻底避免 PC 架构残留导致的资源编译崩溃。
- 未检测到 aapt2 时，如位于 Termux 且可用 `pkg`，脚本会自动尝试安装 `aapt` 与 `android-tools`，随后重新搜索本地 aapt2；仍未找到则终止并提示在手机端先安装。
- Gradle 调用始终附带 `-Dandroid.aapt2FromMaven=false -Dandroid.aapt2FromMavenOverride=<本地aapt2>`，确保 100% 使用本机可执行的 aapt2 构建。

## 2025-12-31 Termux 终极避坑脚本强化
- `run.sh` 默认锁定 SDK 下载架构为 `linux/arm64`，统一 `ANDROID_HOME=/data/data/com.termux/files/home/android-sdk`、`ANDROID_SDK_ROOT`，并设定 `GRADLE_OPTS=-Dorg.gradle.jvmargs=-Xmx1536m -Dfile.encoding=UTF-8`，清除 `JAVA_TOOL_OPTIONS/_JAVA_OPTIONS` 避免假 agent 造成 JVM 崩溃。
- 强制只用项目 Gradle Wrapper（`bash gradlew`），拒绝系统 Gradle 回退；构建前自动清理隔离的 `.gradle-mobile` 缓存（含 caches/daemon/native）以及 `~/.android`、`~/.cache/gradle`，规避反序列化与 immutable workspace 报错。
- aapt2 策略升级：优先检测预置路径 `/data/data/com.termux/files/home/android-tools-arm64/aapt2`，按 Termux/SDK 顺序查找本机 ARM64 aapt2，使用 `file` 校验架构不符即终止；继续强制 `aapt2FromMavenOverride`，缺失时自动尝试 `pkg install aapt android-tools` 后再搜本机二进制。

## 2026-01-01 Compose Chip API 兼容修复
- 根据 Compose BOM 2024.06.00（Material3 1.2.x）的 API 变更，将主界面所有 `Chip` 切换为 `SuggestionChip`，同步颜色配置与标签写法，避免 `Chip/ChipDefaults` 未解析导致的 Kotlin 编译失败。
- 补充 `Modifier.weight` 等遗漏 import，确保布局填充/Spacer 调用正常解析，并清理因 API 签名变化导致的编译报错。

## 2026-01-02 权重作用域修正
- 修复 `PhoneCanvasArea` 内部直接调用 `Modifier.weight` 导致的 `RowColumnParentData.weight` 作用域错误，改为在父级 `PhoneFramePreview` 的 `ColumnScope` 中传入 `modifier = Modifier.weight(1f)`，确保 Kotlin 编译通过且画布区域正常占满可用空间。

## 2026-01-03 组件对齐与内边距管控
- 新增组件水平对齐（左/居中/右）与内边距滑杆，属性面板可直接调整并同步到假手机画布，文本说明实时展示对齐与内边距取值。
- 画布预览按组件内边距自动收缩宽度并按对齐落位，宽度滑杆随内边距动态收敛，确保所有组件尺寸计算基于假手机宽度与分区高度。

## 2026-01-04 图层管理操作强化
- 属性面板图层列表新增上移/下移、复制、删除操作，维持聚焦、显示/隐藏、锁定/解锁的原有能力，便于在假手机画布上快速调整层级和复用组件。
- 新增组件复制后自动聚焦并更新命名，删除时回退到最近图层，保持编辑流程连续，便于继续生成兼容手机端的布局。

## 2026-01-05 假手机布局校验与尺寸工具
- 新增全局 `regionHeightFor`/`maxRegionWidth` 计算方法，统一假手机分区的高度与可用宽度计算，避免重复逻辑导致的越界或作用域错误。
- 属性面板加入“假手机校验”卡片，基于设备/分区尺寸与透明度阈值给出中文提示，帮助在手机端快速发现宽高越界或透明度过低的问题。
- 尺寸滑杆改用统一的区域高度计算，确保上限与校验提示一致，持续强调“画布=假手机，属性只按手机尺寸计算”。

## 2026-01-06 Compose 基础依赖补齐
- `:app:compileDebugKotlin` 报 `align/weight` 未解析，原因是缺少 Compose Foundation 依赖，导致布局相关扩展函数无法从 BOM 中解析。
- 补充 `androidx.compose.foundation:foundation` 依赖，确保 `Modifier.weight` 与 `Modifier.align` 等布局扩展在手机端编译正常可用。
